<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ù…Ø­ØªØ±ÙÙŠÙ† - Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ù‡Ø¬ÙˆÙ…ÙŠ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <style>
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background-color: #000; }

        .bg-image {
            position: fixed; left: 0; right: 0; top: 0; bottom: 0; z-index: -1;
            background-image: url('https://images.unsplash.com/photo-1529699211952-734e80c4d42b?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover; background-position: center;
            filter: blur(8px) brightness(0.4); transform: scale(1.1);
        }

        #ui-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; color: white; }
        #game-container { position: relative; border: 4px solid rgba(255,255,255,0.2); border-radius: 10px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        #board { width: 450px; }

        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; border-radius: 6px;
        }

        .menu-btn {
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white; border: none; padding: 12px 30px; font-size: 18px;
            cursor: pointer; margin: 10px; border-radius: 30px; width: 240px;
            transition: 0.3s; font-weight: bold;
        }
        .menu-btn:hover { transform: translateY(-3px); filter: brightness(1.2); }
        .online-btn { background: linear-gradient(135deg, #3498db, #2980b9); }

        #scoreboard { position: absolute; top: -60px; left: 0; width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .points-badge { background: #f1c40f; color: #000; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        
        #undo-btn { margin-top: 15px; background: #555; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        #undo-btn:not(:disabled) { background: #e74c3c; }

        .check-highlight { box-shadow: inset 0 0 15px 15px rgba(255, 0, 0, 0.7) !important; background-color: rgba(255, 0, 0, 0.5) !important; }
    </style>
</head>
<body>

    <div class="bg-image"></div>

    <div id="ui-wrapper">
        <div id="game-container">
            <div id="scoreboard">
                <div id="status">Ø¬Ø§Ù‡Ø² Ù„Ù„Ù‚ØªØ§Ù„ØŸ</div>
                <div class="points-badge">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="points-val">0</span></div>
            </div>

            <div id="overlay">
                <div id="main-menu" style="text-align:center;">
                    <h1 style="color:#f1c40f; margin-bottom: 20px;">Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ù…Ù„ÙˆÙƒ</h1>
                    <button class="menu-btn" onclick="showDifficulty()">Ù„Ø¹Ø¨ Ø¶Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>
                    <button class="menu-btn online-btn" onclick="startOnlineSearch()">Ø¨Ø­Ø« Ø¹Ù† Ø®ØµÙ… (Online)</button>
                    <button class="menu-btn" style="background:#8e44ad" onclick="startGame('pvp')">Ù„Ø¹Ø¨ Ù…Ø­Ù„ÙŠ (Ù„Ø§Ø¹Ø¨ÙŠÙ†)</button>
                </div>

                <div id="difficulty-menu" style="display:none; text-align:center;">
                    <h3>Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ­Ø¯ÙŠ:</h3>
                    <button class="menu-btn" style="background:#27ae60" onclick="startGame('ai', 1)">Ø³Ù‡Ù„ (Ù…Ø¨ØªØ¯Ø¦)</button>
                    <button class="menu-btn" style="background:#2980b9" onclick="startGame('ai', 3)">Ù…ØªÙˆØ³Ø· (Ø°ÙƒÙŠ)</button>
                    <button class="menu-btn" style="background:#c0392b" onclick="startGame('ai', 4)">ØµØ¹Ø¨ (Ù‡Ø¬ÙˆÙ…ÙŠ ğŸ”¥)</button>
                    <br>
                    <button onclick="resetMenu()" style="color:white; cursor:pointer; background:none; border:none; text-decoration:underline;">Ø±Ø¬ÙˆØ¹</button>
                </div>
                
                <div id="searching-ui" style="display:none; text-align:center;">
                    <h3>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨...</h3>
                    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto;"></div>
                    <button onclick="location.reload()" style="background:none; border:1px solid white; color:white; padding:5px 10px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>

            <div id="board"></div>
        </div>
        <button id="undo-btn" disabled onclick="handleUndo()">ØªØ±Ø§Ø¬Ø¹ (20 Ù†Ù‚Ø·Ø©) â†©ï¸</button>
    </div>

<script>
    // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ---
    var board = null;
    var game = new Chess();
    var gameMode = 'ai';
    var difficultyDepth = 3;
    var points = parseInt(localStorage.getItem('chess_pts_final')) || 0;

    document.getElementById('points-val').innerText = points;

    // --- Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ù…ØªØ·ÙˆØ± ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± ---
    const pst_pawn = [[0,0,0,0,0,0,0,0],[50,50,50,50,50,50,50,50],[10,10,20,30,30,20,10,10],[5,5,10,25,25,10,5,5],[0,0,0,20,20,0,0,0],[5,-5,-10,0,0,-10,-5,5],[5,10,10,-20,-20,10,10,5],[0,0,0,0,0,0,0,0]];
    const pst_knight = [[-50,-40,-30,-30,-30,-30,-40,-50],[-40,-20,0,0,0,0,-20,-40],[-30,0,10,15,15,10,0,-30],[-30,5,15,20,20,15,5,-30],[-30,0,15,20,20,15,0,-30],[-30,5,10,15,15,10,5,-30],[-40,-20,0,5,5,0,-20,-40],[-50,-40,-30,-30,-30,-30,-40,-50]];
    
    // Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø·Ø¹
    const weights = { p: 100, n: 320, b: 330, r: 500, q: 900, k: 20000 };

    function evaluateBoard(game, moveCount) {
        let totalEval = 0;
        const boardArr = game.board();
        
        // 1. Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø§Ø¯ÙŠ ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ÙŠ
        for (let i = 0; i < 8; i++) {
            for (let j = 0; j < 8; j++) {
                let piece = boardArr[i][j];
                if (piece) {
                    let val = weights[piece.type];
                    // Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø¨ÙŠØ¯Ù‚ ÙˆØ§Ù„Ø­ØµØ§Ù† ÙÙ‚Ø· Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                    if (piece.type === 'p') val += (piece.color === 'w' ? pst_pawn[i][j] : pst_pawn[7-i][j]);
                    if (piece.type === 'n') val += pst_knight[i][j];
                    
                    totalEval += (piece.color === 'w' ? val : -val);
                }
            }
        }

        // 2. Ù…ÙƒØ§ÙØ£Ø© Ø­Ø±ÙŠØ© Ø§Ù„Ø­Ø±ÙƒØ© (Mobility) - ØªÙ…Ù†Ø¹ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ù…Ù† Ø®Ù†Ù‚ Ù†ÙØ³Ù‡
        // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¬Ø¨Ø±Ù‡ Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø±ÙƒØ§Øª ØªÙØªØ­ Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
        if (game.turn() === 'b') {
            totalEval += game.moves().length * 2; 
        } else {
            totalEval -= game.moves().length * 2;
        }

        // 3. Ø¥Ø¶Ø§ÙØ© "Ø¶Ø¬ÙŠØ¬" Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ Ù„ÙƒØ³Ø± Ø§Ù„ØªØ¹Ø§Ø¯Ù„ ÙˆÙ…Ù†Ø¹ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
        totalEval += (Math.random() * 0.5) - 0.25;

        return totalEval;
    }

    function minimax(game, depth, alpha, beta, isMax) {
        // ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        if (depth === 0) return -evaluateBoard(game);

        // **Ø§Ù„Ø®Ø¯Ø¹Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±**:
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙˆØ¶Ø¹ÙŠØ© Ù…ÙƒØ±Ø±Ø© 3 Ù…Ø±Ø§Øª (Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ø´Ø·Ø±Ù†Ø¬)ØŒ Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ Ø®Ø³Ø§Ø±Ø© Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± (-5000)
        // Ù‡Ø°Ø§ Ø³ÙŠØ¬Ø¨Ø±Ù‡ Ø¹Ù„Ù‰ ØªØ¬Ù†Ø¨ Ø£ÙŠ Ø­Ø±ÙƒØ© ØªØ¤Ø¯ÙŠ Ù„Ù„ØªØ¹Ø§Ø¯Ù„ Ø¨Ø§Ù„ØªÙƒØ±Ø§Ø±
        if (game.in_threefold_repetition()) {
            return isMax ? -5000 : 5000; 
        }

        let moves = game.moves();
        
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø±ÙƒØ§Øª: Ø§Ù„Ø£ÙƒÙ„ ÙˆØ§Ù„Ù‚ØªÙ„ Ø£ÙˆÙ„Ø§Ù‹
        moves.sort((a, b) => (b.includes('x') || b.includes('+')) ? 1 : -1);

        if (isMax) {
            let bestVal = -99999;
            for (let move of moves) {
                game.move(move);
                bestVal = Math.max(bestVal, minimax(game, depth-1, alpha, beta, false));
                game.undo();
                alpha = Math.max(alpha, bestVal);
                if (beta <= alpha) break;
            }
            return bestVal;
        } else {
            let bestVal = 99999;
            for (let move of moves) {
                game.move(move);
                bestVal = Math.min(bestVal, minimax(game, depth-1, alpha, beta, true));
                game.undo();
                beta = Math.min(beta, bestVal);
                if (beta <= alpha) break;
            }
            return bestVal;
        }
    }

    function makeBestMove() {
        let moves = game.moves();
        if (moves.length === 0) return;

        let bestMove = null;
        let bestValue = -99999;

        for (let move of moves) {
            game.move(move);
            // Ù†ÙØ­Øµ: Ù‡Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ© Ø³ØªØ¬Ø¹Ù„Ù†Ø§ Ù†ÙƒØ±Ø± Ø§Ù„ÙˆØ¶Ø¹ÙŠØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŸ
            let repetitionPenalty = 0;
            if (game.in_threefold_repetition()) {
                repetitionPenalty = -1000; // Ø¹Ù‚ÙˆØ¨Ø© Ù‡Ø§Ø¦Ù„Ø© Ù„Ù„ØªÙƒØ±Ø§Ø±
            }

            // Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙŠÙ†ÙŠ Ù…Ø§ÙƒØ³ + Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©
            let val = minimax(game, difficultyDepth - 1, -100000, 100000, false) + repetitionPenalty;
            
            game.undo();
            
            if (val > bestValue) {
                bestValue = val;
                bestMove = move;
            }
        }
        
        game.move(bestMove);
        board.position(game.fen());
        updateStatus();
    }

    // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ---
    function onDragStart(source, piece) {
        if (game.game_over()) return false;
        if (gameMode === 'ai' && piece.search(/^b/) !== -1) return false;
    }

    function onDrop(source, target) {
        let move = game.move({ from: source, to: target, promotion: 'q' });
        if (move === null) return 'snapback';
        updateStatus();
        if (gameMode === 'ai' && !game.game_over()) {
            window.setTimeout(makeBestMove, 250);
        }
    }

    function updateStatus() {
        highlightKing();
        let status = game.turn() === 'b' ? "Ø§Ù„Ø®ØµÙ… ÙŠÙÙƒØ±..." : "Ø¯ÙˆØ±Ùƒ";
        
        if (game.in_checkmate()) {
            status = "ÙƒØ´ Ù…Ù„Ùƒ!";
            if (gameMode === 'ai' && game.turn() === 'b') {
                let winPoints = difficultyDepth === 1 ? 10 : (difficultyDepth === 3 ? 20 : 50);
                alert(`Ø£Ø­Ø³Ù†Øª! ÙØ²Øª ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ ${winPoints} Ù†Ù‚Ø·Ø©`);
                updatePoints(winPoints);
            } else if (gameMode === 'ai' && game.turn() === 'w') {
                status = "Ø®Ø³Ø±Øª! Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ø§Ù†ØªØµØ±.";
            }
        } else if (game.in_draw()) {
            status = "ØªØ¹Ø§Ø¯Ù„!";
        }

        document.getElementById('status').innerText = status;
        document.getElementById('undo-btn').disabled = (points < 20);
    }

    function highlightKing() {
        $('.square-55d63').removeClass('check-highlight');
        if (game.in_check()) {
            game.board().forEach((row, r) => {
                row.forEach((sq, c) => {
                    if (sq && sq.type === 'k' && sq.color === game.turn()) {
                        $('.square-' + String.fromCharCode(97+c) + (8-r)).addClass('check-highlight');
                    }
                });
            });
        }
    }

    function updatePoints(amount) {
        points += amount;
        localStorage.setItem('chess_pts_final', points);
        document.getElementById('points-val').innerText = points;
    }

    function handleUndo() {
        if (points >= 20) {
            game.undo(); if (gameMode === 'ai') game.undo();
            board.position(game.fen());
            updatePoints(-20);
            updateStatus();
        }
    }

    // Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØ­ÙƒÙ…
    function showDifficulty() { $('#main-menu').hide(); $('#difficulty-menu').show(); }
    function resetMenu() { $('#difficulty-menu').hide(); $('#main-menu').show(); }
    function startOnlineSearch() { $('#main-menu').hide(); $('#searching-ui').show(); setTimeout(() => { alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† Ø§Ù„Ø¢Ù†. Ø¬Ø§Ø±Ù ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„Ø¹Ø¨ Ø¶Ø¯ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±."); location.reload(); }, 4000); }

    function startGame(mode, depth) {
        gameMode = mode;
        difficultyDepth = depth;
        $('#overlay').fadeOut();
        board = Chessboard('board', {
            draggable: true, position: 'start',
            onDragStart: onDragStart, onDrop: onDrop,
            onSnapEnd: () => board.position(game.fen()),
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
        updateStatus();
    }
    
    // Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†
    $('<style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>').appendTo('head');
</script>
</body>
</html>