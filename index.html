<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ù…Ù„ÙˆÙƒ - Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø¹Ø§Ù„Ù…ÙŠ</title>

    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --move-dot-size: 24px; --capture-ring-size: 48px; }
        body, html { height:100%; margin:0; font-family: "Segoe UI", sans-serif; background:#000; color:#fff; overflow:hidden; }
        .bg-image{position:fixed;left:0;right:0;top:0;bottom:0;z-index:-1;background-image:url('https://images.unsplash.com/photo-1529699211952-734e80c4d42b?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');background-size:cover;background-position:center;filter:blur(8px) brightness(0.35);transform:scale(1.08);}
        #ui-wrapper{display:flex;align-items:center;justify-content:center;height:100vh;}
        #game-container{position:relative;border-radius:12px;padding:28px;border:4px solid rgba(255,255,255,0.06);box-shadow:0 30px 60px rgba(0,0,0,0.8);background:rgba(0,0,0,0.15);}
        #board{width:460px;height:460px;}
        .square-55d63 { position: relative !important; }
        .square-55d63.highlight-move::after { content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: var(--move-dot-size); height: var(--move-dot-size); background: rgba(128,128,128,0.4); border-radius: 50%; pointer-events: none; }
        .square-55d63.highlight-capture::after { content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: var(--capture-ring-size); height: var(--capture-ring-size); border: 4px solid rgba(231, 76, 60, 0.5); border-radius: 50%; pointer-events: none; }
        .square-55d63.check-highlight { box-shadow: inset 0 0 15px 5px rgba(231, 76, 60, 0.6) !important; }
        #overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:50;background:rgba(0,0,0,0.65);border-radius:10px;}
        .menu-card{background:rgba(255,255,255,0.06);padding:28px;border-radius:14px;text-align:center;backdrop-filter:blur(6px);}
        .menu-btn{display:block;width:260px;margin:10px auto;padding:12px 18px;border-radius:28px;border:none;font-weight:700;cursor:pointer;color:#fff}
        .menu-btn.primary{background:linear-gradient(135deg,#e67e22,#d35400)}
        .menu-btn.online{background:linear-gradient(135deg,#3498db,#2980b9)}
        #scoreboard{position:absolute;left:0;top:-58px;width:100%;display:flex;justify-content:space-between;align-items:center}
        .points-badge{background:#f1c40f;color:#000;padding:6px 14px;border-radius:20px;font-weight:700}
        #exit-btn{position:absolute;right:0;top:-58px;background:rgba(231,76,60,0.14);Color:#ffb3b0;border:1px solid #e74c3c;padding:6px 12px;border-radius:6px;display:none;cursor:pointer}
        #result-screen{display:none;position:absolute;inset:0;background:rgba(0,0,0,0.92);z-index:100;border-radius:10px;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:24px}
        .result-text{font-size:64px;font-weight:900;margin-bottom:12px;letter-spacing:2px}
        .win-color{color:#f1c40f} .lose-color{color:#e74c3c}
        .points-added{font-size:20px;color:#2ecc71;margin-bottom:18px}
        .result-actions{display:flex;flex-direction:column;gap:10px;width:320px;align-items:center}
        #undo-btn{display:block;margin-top:14px;background:#555;border:none;color:#fff;padding:10px 18px;border-radius:8px;cursor:pointer}
        #undo-btn:disabled{opacity:0.5;cursor:not-allowed}
    </style>
</head>
<body>
    <div class="bg-image"></div>
    <div id="ui-wrapper">
        <div id="game-container">
            <div id="scoreboard">
                <div id="status">Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ù…Ù„ÙˆÙƒ</div>
                <div class="points-badge">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="points-val">0</span></div>
            </div>
            <button id="exit-btn" onclick="confirmExit()">Ø®Ø±ÙˆØ¬ âœ–</button>

            <div id="result-screen">
                <div id="res-title" class="result-text"></div>
                <div id="res-points" class="points-added"></div>
                <div class="result-actions">
                    <button class="menu-btn" onclick="location.reload()" style="background:#2ecc71;color:#000">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    <button class="menu-btn online" onclick="startOnlineSearch()">Ø¨Ø­Ø« Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
                </div>
            </div>

            <div id="overlay">
                <div id="main-menu" class="menu-card">
                    <h1 style="color:#f1c40f;margin:0 0 16px 0">Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ù…Ù„ÙˆÙƒ</h1>
                    <button class="menu-btn online" onclick="startOnlineSearch()">Ø¨Ø­Ø« Ø¹Ù† Ø®ØµÙ… (Online)</button>
                    <button class="menu-btn primary" onclick="showDifficulty()">Ù„Ø¹Ø¨ Ø¶Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>
                    <button class="menu-btn" style="background:#8e44ad" onclick="startGame('pvp',0)">Ù„Ø¹Ø¨ Ù…Ø­Ù„ÙŠ (Offline)</button>
                </div>
                <div id="difficulty-menu" class="menu-card" style="display:none">
                    <h3>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</h3>
                    <button class="menu-btn" style="background:#27ae60" onclick="startGame('ai',1)">Ø³Ù‡Ù„</button>
                    <button class="menu-btn" style="background:#2980b9" onclick="startGame('ai',3)">Ù…ØªÙˆØ³Ø·</button>
                    <button class="menu-btn" style="background:#c0392b" onclick="startGame('ai',4)">ØµØ¹Ø¨ ğŸ”¥</button>
                    <button onclick="$('#difficulty-menu').hide(); $('#main-menu').show()" style="color:#fff;cursor:pointer;background:none;border:none;text-decoration:underline">Ø±Ø¬ÙˆØ¹</button>
                </div>
            </div>

            <div id="board"></div>
        </div>
    </div>
    
    <div style="position:fixed;left:20px;bottom:20px;z-index:80">
        <button id="undo-btn" disabled onclick="handleUndo()">ØªØ±Ø§Ø¬Ø¹ (20 Ù†Ù‚Ø·Ø©) â†©ï¸</button>
    </div>

<script>
    // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAwcOUbYnyL7EfMnMeJRHZ2O5j0k9MRFLw",
        authDomain: "chees-3ae25.firebaseapp.com",
        projectId: "chees-3ae25",
        storageBucket: "chees-3ae25.firebasestorage.app",
        messagingSenderId: "25263870247",
        appId: "1:25263870247:web:8813016a3c8a32a4219902",
        measurementId: "G-XHY67939EW"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
    var board = null;
    var game = new Chess();
    var gameMode = 'ai'; // ai, pvp, online
    var difficultyDepth = 3;
    var gameId = null; // Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© Ù„Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
    var myColor = 'w'; // Ù„ÙˆÙ†ÙŠ ÙÙŠ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
    var gameOver = false;
    var points = parseInt(localStorage.getItem('chess_pts_final')) || 0;
    var selectedSquare = null;
    
    document.getElementById('points-val').innerText = points;

    // --- 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Matchmaking) ---
    async function startOnlineSearch() {
        $('#result-screen').hide();
        $('#main-menu').hide();
        document.getElementById('status').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...";

        try {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØºØ±ÙØ© ÙÙŠÙ‡Ø§ Ø´Ø®Øµ ÙŠÙ†ØªØ¸Ø±
            const snapshot = await db.collection('games')
                .where('status', '==', 'waiting')
                .limit(1)
                .get();

            if (snapshot.empty) {
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºØ±ÙØŒ Ø£Ù†Ø´Ø¦ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙƒÙ† Ø£Ù†Øª Ø§Ù„Ø£Ø¨ÙŠØ¶
                const newGame = await db.collection('games').add({
                    fen: 'start',
                    status: 'waiting',
                    turn: 'w',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                gameId = newGame.id;
                myColor = 'w';
                document.getElementById('status').innerText = "Ø£Ù†Øª Ø§Ù„Ø£Ø¨ÙŠØ¶.. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø®ØµÙ…...";
                startGame('online', 0);
            } else {
                // ÙˆØ¬Ø¯Ù†Ø§ ØºØ±ÙØ©ØŒ Ø§Ù†Ø¶Ù… Ø¥Ù„ÙŠÙ‡Ø§ ÙˆÙƒÙ† Ø£Ù†Øª Ø§Ù„Ø£Ø³ÙˆØ¯
                const doc = snapshot.docs[0];
                gameId = doc.id;
                myColor = 'b';
                await db.collection('games').doc(gameId).update({ status: 'playing' });
                document.getElementById('status').innerText = "ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„! Ø£Ù†Øª Ø§Ù„Ø£Ø³ÙˆØ¯";
                startGame('online', 0);
            }
            
            // Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø±ÙƒØ§Øª Ø§Ù„Ø®ØµÙ…
            listenForMoves();
        } catch (error) {
            console.error(error);
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
            location.reload();
        }
    }

    function listenForMoves() {
        db.collection('games').doc(gameId).onSnapshot((doc) => {
            const data = doc.data();
            if (!data) return;

            // Ø¥Ø°Ø§ Ø¯Ø®Ù„ Ø§Ù„Ø®ØµÙ… Ø§Ù„ØºØ±ÙØ©ØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨
            if (myColor === 'w' && data.status === 'playing' && document.getElementById('status').innerText.includes("Ø§Ù†ØªØ¸Ø§Ø±")) {
                document.getElementById('status').innerText = "Ø§Ù†Ø¶Ù… Ø§Ù„Ø®ØµÙ…! Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨";
            }

            // Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ù„ÙˆØ­Ø© (Ø§Ù„Ø®ØµÙ… Ù„Ø¹Ø¨ Ø­Ø±ÙƒØ©)
            if (data.fen && data.fen !== game.fen() && data.fen !== 'start') {
                game.load(data.fen);
                board.position(data.fen);
                updateStatus();
                // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¨Ø³ÙŠØ· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            }
        });
    }

    // --- 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Minimax) ---
    const weights = { p:100, n:320, b:330, r:500, q:900, k:20000 };
    function evaluateBoard(g) {
        let total = 0;
        g.board().forEach(row => row.forEach(p => { if(p) total += (p.color==='w'?weights[p.type]:-weights[p.type]); }));
        return total;
    }
    function minimax(g, depth, alpha, beta, isMax) {
        if (depth === 0) return -evaluateBoard(g);
        let moves = g.moves();
        if (isMax) {
            let best = -99999;
            for (let m of moves) { g.move(m); best = Math.max(best, minimax(g, depth-1, alpha, beta, false)); g.undo(); alpha = Math.max(alpha, best); if (beta <= alpha) break; }
            return best;
        } else {
            let best = 99999;
            for (let m of moves) { g.move(m); best = Math.min(best, minimax(g, depth-1, alpha, beta, true)); g.undo(); beta = Math.min(beta, best); if (beta <= alpha) break; }
            return best;
        }
    }
    function makeBestMove() {
        if (gameOver) return;
        let moves = game.moves();
        if (moves.length === 0) return;
        let bestMove = null; let bestVal = -99999;
        for (let m of moves) {
            game.move(m);
            let val = minimax(game, difficultyDepth-1, -100000, 100000, false);
            game.undo();
            if (val > bestVal) { bestVal = val; bestMove = m; }
        }
        if(bestMove) {
            game.move(bestMove);
            board.position(game.fen());
            updateStatus();
        }
    }

    // --- 5. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª (Game Loop) ---
    function removeHighlights() { $('.square-55d63').removeClass('highlight-move highlight-capture'); }
    
    function highlightPossibleMoves(square) {
        let moves = game.moves({ square: square, verbose: true });
        moves.forEach(m => {
            $('.square-' + m.to).addClass(m.captured ? 'highlight-capture' : 'highlight-move');
        });
    }

    function onSquareClick() {
        if (gameOver) return;
        
        // ğŸ›‘ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†: Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø¯ÙˆØ±Ùƒ Ø£Ùˆ Ù„Ù… ØªÙƒÙ† Ù‚Ø·Ø¹Ùƒ
        if (gameMode === 'online') {
            if (game.turn() !== myColor) return; // Ù„ÙŠØ³ Ø¯ÙˆØ±ÙŠ
            // Ø¥Ø°Ø§ Ø­Ø§ÙˆÙ„Øª Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„Ø®ØµÙ…
            let pieceInfo = game.get($(this).attr('data-square'));
            if (pieceInfo && pieceInfo.color !== myColor && !selectedSquare) return;
        }
        
        // Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù€ AI
        if (gameMode === 'ai' && game.turn() === 'b') return;

        let square = $(this).attr('data-square');

        if (selectedSquare) {
            let move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
            if (move === null) {
                let piece = game.get(square);
                if (piece && piece.color === game.turn() && (gameMode !== 'online' || piece.color === myColor)) {
                    selectedSquare = square;
                    removeHighlights();
                    highlightPossibleMoves(square);
                } else {
                    selectedSquare = null;
                    removeHighlights();
                }
            } else {
                // âœ… ØªÙ…Øª Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­
                selectedSquare = null;
                removeHighlights();
                board.position(game.fen());
                
                // ğŸ“¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø±ÙƒØ© Ù„Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
                if (gameMode === 'online') {
                    db.collection('games').doc(gameId).update({
                        fen: game.fen(),
                        turn: game.turn()
                    });
                }

                updateStatus();
                if (gameMode === 'ai' && !gameOver) setTimeout(makeBestMove, 250);
            }
        } else {
            let piece = game.get(square);
            if (piece && piece.color === game.turn()) {
                if (gameMode === 'online' && piece.color !== myColor) return;
                selectedSquare = square;
                highlightPossibleMoves(square);
            }
        }
    }

    function updateStatus() {
        $('.square-55d63').removeClass('check-highlight');
        if (game.in_check()) {
            game.board().forEach((row, r) => {
                row.forEach((sq, c) => {
                    if (sq && sq.type === 'k' && sq.color === game.turn()) {
                        $('.square-' + String.fromCharCode(97+c) + (8-r)).addClass('check-highlight');
                    }
                });
            });
        }

        let statusText = "";
        if (gameMode === 'online') {
            statusText = (game.turn() === myColor) ? "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†!" : "Ø§Ù†ØªØ¸Ø± Ø±Ø¯ Ø§Ù„Ø®ØµÙ…...";
        } else {
            statusText = (game.turn() === 'w') ? "Ø¯ÙˆØ± Ø§Ù„Ø£Ø¨ÙŠØ¶" : "Ø¯ÙˆØ± Ø§Ù„Ø£Ø³ÙˆØ¯";
        }

        if (game.in_checkmate()) {
            gameOver = true;
            let win = false;
            if (gameMode === 'online') win = (game.turn() !== myColor);
            else win = (game.turn() === 'b'); // ÙÙŠ Ø§Ù„Ù€ AI Ø§Ù„Ø£Ø¨ÙŠØ¶ ÙŠÙÙˆØ² Ø¥Ø°Ø§ Ù…Ø§Øª Ø§Ù„Ø£Ø³ÙˆØ¯
            
            showResult(win ? "Ø£Ù†Øª ÙØ§Ø¦Ø²! ğŸ†" : "Ø®Ø³Ø±Øª Ø§Ù„Ù…Ø¹Ø±ÙƒØ© ğŸ’€", win ? 50 : 0);
        } else if (game.in_draw()) {
            showResult("ØªØ¹Ø§Ø¯Ù„!", 0);
        }
        document.getElementById('status').innerText = statusText;
        
        // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ±Ø§Ø¬Ø¹ ÙÙŠ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
        document.getElementById('undo-btn').disabled = (points < 20 || gameMode === 'online');
    }

    function startGame(mode, depth) {
        gameMode = mode;
        difficultyDepth = depth;
        game = new Chess();
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù„ÙˆØ­Ø©
        let orientation = 'white';
        if (mode === 'online' && myColor === 'b') orientation = 'black';

        if (!board) {
            board = Chessboard('board', {
                position: 'start',
                draggable: false, // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù‚Ø± ÙÙ‚Ø· Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„Ø¯ÙˆØ§Ø¦Ø±
                orientation: orientation,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });
        } else {
            board.start();
            board.orientation(orientation);
        }

        $('#overlay').fadeOut();
        $('#exit-btn').show();
        gameOver = false;
        selectedSquare = null;
        removeHighlights();
        
        $(document).off('click', '.square-55d63', onSquareClick);
        $(document).on('click', '.square-55d63', onSquareClick);
        updateStatus();
    }

    function showResult(text, pts) {
        gameOver = true;
        $('#res-title').text(text).attr('class', text.includes('ÙØ§Ø¦Ø²') ? 'result-text win-color' : 'result-text lose-color');
        if (pts > 0) { points += pts; localStorage.setItem('chess_pts_final', points); $('#res-points').text("+"+pts); }
        else $('#res-points').text('');
        $('#result-screen').css('display','flex');
    }

    function handleUndo() {
        if (gameMode === 'online') { alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ ÙÙŠ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†!"); return; }
        if (points >= 20 && !gameOver) {
            game.undo(); if(gameMode==='ai') game.undo();
            board.position(game.fen());
            points -= 20; localStorage.setItem('chess_pts_final', points);
            document.getElementById('points-val').innerText = points;
            updateStatus();
        }
    }

    function showDifficulty() { $('#main-menu').hide(); $('#difficulty-menu').show(); }
    function confirmExit() { if(confirm("Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ø³ØªÙÙ‚Ø¯ Ø§ØªØµØ§Ù„Ùƒ.")) location.reload(); }
</script>
</body>
</html>
