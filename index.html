<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ù…Ù„ÙˆÙƒ - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>

    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <style>
        :root {
            --move-dot-size: 24px;
            --capture-ring-size: 48px;
        }

        body, html { height:100%; margin:0; font-family: "Segoe UI", sans-serif; background:#000; color:#fff; overflow:hidden; }
        .bg-image{position:fixed;left:0;right:0;top:0;bottom:0;z-index:-1;background-image:url('https://images.unsplash.com/photo-1529699211952-734e80c4d42b?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');background-size:cover;background-position:center;filter:blur(8px) brightness(0.35);transform:scale(1.08);}
        #ui-wrapper{display:flex;align-items:center;justify-content:center;height:100vh;}
        #game-container{position:relative;border-radius:12px;padding:28px;border:4px solid rgba(255,255,255,0.06);box-shadow:0 30px 60px rgba(0,0,0,0.8);background:rgba(0,0,0,0.15);}
        #board{width:460px;height:460px;}

        .square-55d63 { position: relative !important; }

        .square-55d63.highlight-move::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: var(--move-dot-size);
            height: var(--move-dot-size);
            background: rgba(128,128,128,0.4); /* Ø±ØµØ§ØµÙŠ Ø´ÙØ§Ù Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø®Ø¶Ø± */
            border-radius: 50%;
            pointer-events: none;
        }

        .square-55d63.highlight-capture::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: var(--capture-ring-size);
            height: var(--capture-ring-size);
            border: 4px solid rgba(231, 76, 60, 0.5);
            border-radius: 50%;
            pointer-events: none;
        }

        .square-55d63.check-highlight {
            box-shadow: inset 0 0 15px 5px rgba(231, 76, 60, 0.6) !important;
        }

        #overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:50;background:rgba(0,0,0,0.65);border-radius:10px;}
        .menu-card{background:rgba(255,255,255,0.06);padding:28px;border-radius:14px;text-align:center;backdrop-filter:blur(6px);}
        .menu-btn{display:block;width:260px;margin:10px auto;padding:12px 18px;border-radius:28px;border:none;font-weight:700;cursor:pointer;color:#fff}
        .menu-btn.primary{background:linear-gradient(135deg,#e67e22,#d35400)}
        .menu-btn.online{background:linear-gradient(135deg,#3498db,#2980b9)}
        #scoreboard{position:absolute;left:0;top:-58px;width:100%;display:flex;justify-content:space-between;align-items:center}
        .points-badge{background:#f1c40f;color:#000;padding:6px 14px;border-radius:20px;font-weight:700}
        #exit-btn{position:absolute;right:0;top:-58px;background:rgba(231,76,60,0.14);Color:#ffb3b0;border:1px solid #e74c3c;padding:6px 12px;border-radius:6px;display:none;cursor:pointer}

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© */
        #result-screen{display:none;position:absolute;inset:0;background:rgba(0,0,0,0.92);z-index:100;border-radius:10px;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:24px}
        .result-text{font-size:64px;font-weight:900;margin-bottom:12px;letter-spacing:2px}
        .win-color{color:#f1c40f}
        .lose-color{color:#e74c3c}
        .points-added{font-size:20px;color:#2ecc71;margin-bottom:18px}
        .result-actions{display:flex;flex-direction:column;gap:10px;width:320px;align-items:center}

        #undo-btn{display:block;margin-top:14px;background:#555;border:none;color:#fff;padding:10px 18px;border-radius:8px;cursor:pointer}
        #undo-btn:disabled{opacity:0.5;cursor:not-allowed}
    </style>
</head>
<body>
    <div class="bg-image"></div>
    <div id="ui-wrapper">
        <div id="game-container">
            <div id="scoreboard">
                <div id="status">Ø¬Ø§Ù‡Ø² Ù„Ù„Ù‚ØªØ§Ù„ØŸ</div>
                <div class="points-badge">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="points-val">0</span></div>
            </div>
            <button id="exit-btn" onclick="confirmExit()">Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© âœ–</button>

            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØ§Ù…Ù„Ø© -->
            <div id="result-screen" role="dialog" aria-hidden="true">
                <div id="res-title" class="result-text"></div>
                <div id="res-points" class="points-added"></div>
                <div class="result-actions">
                    <button class="menu-btn" onclick="goToMainMenu()" style="background:#2ecc71;color:#000">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    <button class="menu-btn online" onclick="startOnlineFromResult()">Ø§Ù„Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>
                    <button class="menu-btn primary" onclick="restartGame()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨</button>
                </div>
            </div>

            <div id="overlay">
                <div id="main-menu" class="menu-card">
                    <h1 style="color:#f1c40f;margin:0 0 16px 0">Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ù…Ù„ÙˆÙƒ</h1>
                    <button class="menu-btn primary" onclick="showDifficulty()">Ù„Ø¹Ø¨ Ø¶Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>
                    <button class="menu-btn online" onclick="startOnlineSearch()">Ø¨Ø­Ø« Ø¹Ù† Ø®ØµÙ… (Online)</button>
                    <button class="menu-btn" style="background:#8e44ad" onclick="startGame('pvp',0)">Ù„Ø¹Ø¨ Ù…Ø¹ Ø£Ø®ÙˆÙƒ (Ù…Ø­Ù„ÙŠ)</button>
                </div>
                <div id="difficulty-menu" class="menu-card" style="display:none">
                    <h3>Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ­Ø¯ÙŠ:</h3>
                    <button class="menu-btn" style="background:#27ae60" onclick="startGame('ai',1)">Ø³Ù‡Ù„ (Ù…Ø¨ØªØ¯Ø¦)</button>
                    <button class="menu-btn" style="background:#2980b9" onclick="startGame('ai',3)">Ù…ØªÙˆØ³Ø· (Ø°ÙƒÙŠ)</button>
                    <button class="menu-btn" style="background:#c0392b" onclick="startGame('ai',4)">ØµØ¹Ø¨ (Ù‡Ø¬ÙˆÙ…ÙŠ ğŸ”¥)</button>
                    <br>
                    <button onclick="resetMenu()" style="background:none;border:none;color:#fff;text-decoration:underline;cursor:pointer">Ø±Ø¬ÙˆØ¹</button>
                </div>
            </div>

            <div id="board"></div>
        </div>
    </div>

    <div style="position:fixed;left:20px;bottom:20px;z-index:80">
        <button id="undo-btn" disabled onclick="handleUndo()">ØªØ±Ø§Ø¬Ø¹ (20 Ù†Ù‚Ø·Ø©) â†©ï¸</button>
    </div>

<script>
    var board = null;
    var game = new Chess();
    var gameMode = 'ai';
    var difficultyDepth = 3;
    var points = parseInt(localStorage.getItem('chess_pts_final')) || 0;
    document.getElementById('points-val').innerText = points;

    var gameOver = false; // Ø¹Ù„Ø§Ù…Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©

    // Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù‚Ù„Ø§Ø¹ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
    var recentRookMoves = []; // ÙƒÙ„ Ø¹Ù†ØµØ±: { color:'w'|'b', from:'a1', to:'a3' }
    const RECENT_ROOK_STORE = 6; // Ø­Ø¬Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©

    const weights = { p:100, n:320, b:330, r:500, q:900, k:20000 };

    function evaluateBoard(g) {
        let totalEval = 0;
        const boardArr = g.board();
        for (let i=0; i<8; i++) {
            for (let j=0; j<8; j++) {
                let piece = boardArr[i][j];
                if (piece) {
                    let val = weights[piece.type];
                    totalEval += (piece.color === 'w' ? val : -val);
                }
            }
        }
        return totalEval;
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø§ÙƒØªØ´Ø§Ù Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø­Ø±ÙƒØ© Ø§Ù„Ù‚Ù„Ø¹Ø© ØªØ±Ø¯ Ø¹Ù„Ù‰ Ø­Ø±ÙƒØ© Ø³Ø§Ø¨Ù‚Ø© (back-and-forth)
    function isRookBackAndForth(mvObj) {
        if (mvObj.piece !== 'r') return false;
        let last = recentRookMoves.length ? recentRookMoves[recentRookMoves.length - 1] : null;
        if (!last) return false;
        // Ù„Ùˆ Ø¢Ø®Ø± Ø­Ø±ÙƒØ© Ù‚Ù„Ø¹Ø© Ù„Ù†ÙØ³ Ø§Ù„Ù„ÙˆÙ† Ù‡ÙŠ Ø¹ÙƒØ³ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© => ØªØ¹ØªØ¨Ø± ØªÙƒØ±Ø§Ø±
        if (last.color === mvObj.color && last.from === mvObj.to && last.to === mvObj.from) {
            return true;
        }
        return false;
    }

    function minimax(g, depth, alpha, beta, isMax) {
        if (depth === 0) return -evaluateBoard(g);
        let moves = g.moves();
        if (isMax) {
            let bestVal = -99999;
            for (let m of moves) {
                g.move(m);
                bestVal = Math.max(bestVal, minimax(g, depth-1, alpha, beta, false));
                g.undo();
                alpha = Math.max(alpha, bestVal);
                if (beta <= alpha) break;
            }
            return bestVal;
        } else {
            let bestVal = 99999;
            for (let m of moves) {
                g.move(m);
                bestVal = Math.min(bestVal, minimax(g, depth-1, alpha, beta, true));
                g.undo();
                beta = Math.min(beta, bestVal);
                if (beta <= alpha) break;
            }
            return bestVal;
        }
    }

    // ================= ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙƒØ¨ÙŠØ±Ø© Ù‡Ù†Ø§ Ù„Ù…Ù†Ø¹ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¨Ù„Ø§ Ù‡Ø¯Ù =================
    function makeBestMove() {
        if (gameOver) return;
        // Ù†Ø£Ø®Ø° Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø¨ØªÙØµÙŠÙ„ verbose Ø­ØªÙ‰ Ù†Ø¹Ø±Ù Ø§Ù„Ù‚Ø·Ø¹Ø© Ù…Ù† Ø£ÙŠÙ† ÙˆØ¥Ù„Ù‰ Ø£ÙŠÙ†
        let moves = game.moves({ verbose: true });
        if (moves.length === 0) return;

        let bestMoveObj = null;
        let bestValue = -99999;

        for (let mvObj of moves) {
            // Ù…Ù†Ø¹ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù‚Ù„Ø¹Ø© Ø§Ù„ØªÙŠ ØªÙƒØ±Ø± Ù†ÙØ³ Ø§Ù„ØªØ­Ø±Ùƒ (back-and-forth)
            if (mvObj.piece === 'r' && !mvObj.captured) {
                if (isRookBackAndForth(mvObj)) {
                    // Ù†ØªØ®Ø·Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø£Ù†Ù‡Ø§ ØªØ±Ø¯ Ø¹Ù„Ù‰ Ù†ÙØ³Ù‡Ø§
                    continue;
                }
            }

            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­Ø±ÙƒØ©
            game.move({ from: mvObj.from, to: mvObj.to, promotion: 'q' });

            // Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø±ÙƒØ© Ù†ØªØ­Ù‚Ù‚ Ø¥Ù† ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ù„Ø¹Ø© Ø§Ù„ØªÙŠ ØªØ­Ø±ÙƒØª (Ø¥Ù† ÙƒØ§Ù†Øª Ù‚Ù„Ø¹Ø©) Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø£Ø³Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø®ØµÙ…
            let immediateDanger = false;
            if (mvObj.piece === 'r') {
                let opponentMoves = game.moves({ verbose: true });
                for (let op of opponentMoves) {
                    if (op.captured && op.to === mvObj.to) {
                        immediateDanger = true;
                        break;
                    }
                }
            }

            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø±ÙƒØ© ØªØ³Ø¨Ø¨ ØªØ¹Ø±ÙŠØ¶ Ø§Ù„Ù‚Ù„Ø¹Ø© Ù„Ù„Ø£Ø³Ø± ÙÙ†ØªØ¬Ù†Ø¨Ù‡Ø§ (ØªØ®Ø·ÙŠ)
            if (immediateDanger) {
                game.undo();
                continue;
            }

            // Ù†Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø±ÙƒØ© Ø¹Ø¨Ø± minimax
            let val = minimax(game, difficultyDepth - 1, -100000, 100000, false);

            game.undo();

            // Ø®ÙÙ‘Ø¶ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„ØªÙŠ Ù‡ÙŠ Ø­Ø±ÙƒØ§Øª Ù‚Ù„Ø¹Ø© Ø¨Ù„Ø§ Ø§Ø­ØªÙ„Ø§Ù„ Ø£Ùˆ ØªØ£Ø«ÙŠØ± (ÙƒØ¹Ù‚Ø§Ø¨ Ø¨Ø³ÙŠØ·) Ø­ØªÙ‰ Ù„Ø§ ÙŠÙØ¶Ù„Ù‡Ø§ Ø§Ù„Ù…Ø­Ø±Ùƒ
            if (mvObj.piece === 'r' && !mvObj.captured) {
                // Ù†Ø¹Ø·ÙŠ Ø®ØµÙ… Ø¨Ø³ÙŠØ· Ù„Ù„Ù‚ÙŠÙ…Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ù…Ù† Ø§Ù„ØªØ¬ÙˆØ§Ù„ Ø¨Ø¯ÙˆÙ† Ù‡Ø¯Ù
                val -= 40;
            }

            // Ø§Ø®ØªØ± Ø£ÙØ¶Ù„ Ø­Ø±ÙƒØ©
            if (val > bestValue) {
                bestValue = val;
                bestMoveObj = mvObj;
            }
        }

        // Ù„Ùˆ Ù…Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø­Ø±ÙƒØ© Ø£ÙØ¶Ù„ Ø¨Ø³Ø¨Ø¨ ÙƒÙ„ Ø§Ù„ØªØµÙÙŠØ©ØŒ Ù†Ø¹ÙŠØ¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙˆÙ† Ø§Ù„ØªØµÙÙŠØ© ÙƒØ­Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        if (!bestMoveObj) {
            // Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: Ø§Ø®ØªØ± Ø£ÙŠ Ø£ÙØ¶Ù„ Ø­Ø±ÙƒØ© Ø¹Ø§Ø¯ÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªØ¬Ø§Ù‡Ù„ back-and-forth)
            let fallbackMoves = game.moves({ verbose: true });
            let fv = -99999;
            for (let mvObj of fallbackMoves) {
                game.move({ from: mvObj.from, to: mvObj.to, promotion: 'q' });
                let val = minimax(game, Math.max(1, difficultyDepth - 1), -100000, 100000, false);
                game.undo();
                if (val > fv) { fv = val; bestMoveObj = mvObj; }
            }
        }

        // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø­Ø±ÙƒØ© Ù†Ù‡Ø§Ø¦ÙŠØ© Ù†Ù†ÙØ°Ù‡Ø§ ÙˆÙ†Ø­Ø¯Ø« recentRookMoves
        if (bestMoveObj) {
            game.move({ from: bestMoveObj.from, to: bestMoveObj.to, promotion: 'q' });
            board.position(game.fen());
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù‚Ù„Ø§Ø¹
            if (bestMoveObj.piece === 'r') {
                recentRookMoves.push({ color: bestMoveObj.color, from: bestMoveObj.from, to: bestMoveObj.to });
                if (recentRookMoves.length > RECENT_ROOK_STORE) recentRookMoves.shift();
            }
            updateStatus();
        }
    }
    // =============================================================================

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø± ÙˆØ§Ù„Ø¯ÙˆØ§Ø¦Ø± ---
    var selectedSquare = null;

    function removeHighlights() {
        $('.square-55d63').removeClass('highlight-move highlight-capture');
    }

    function highlightPossibleMoves(square) {
        let moves = game.moves({ square: square, verbose: true });
        moves.forEach(m => {
            let target = $('.square-' + m.to);
            if (m.captured) {
                target.addClass('highlight-capture');
            } else {
                target.addClass('highlight-move');
            }
        });
    }

    function onSquareClick() {
        if (gameOver) return; // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©

        let square = $(this).attr('data-square');

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¯ÙˆØ± Ù„Ù„Ø£Ø³ÙˆØ¯ ÙÙŠ ÙˆØ¶Ø¹ AI Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹
        if (gameMode === 'ai' && game.turn() === 'b') return;

        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ†ÙÙŠØ° Ø­Ø±ÙƒØ©
        if (selectedSquare) {
            let move = game.move({ from: selectedSquare, to: square, promotion: 'q' });

            if (move === null) {
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø­Ø±ÙƒØ© ØµØ­ÙŠØ­Ø©ØŒ ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø¶ØºØ· Ø¹Ù„Ù‰ Ù‚Ø·Ø¹Ø© Ø£Ø®Ø±Ù‰ Ù…Ù† ÙØ±ÙŠÙ‚Ù‡ØŸ
                let piece = game.get(square);
                if (piece && piece.color === game.turn()) {
                    selectedSquare = square;
                    removeHighlights();
                    highlightPossibleMoves(square);
                } else {
                    selectedSquare = null;
                    removeHighlights();
                }
            } else {
                // Ø­Ø±ÙƒØ© Ù†Ø§Ø¬Ø­Ø©
                selectedSquare = null;
                removeHighlights();
                board.position(game.fen());
                updateStatus();
                if (gameMode === 'ai' && !game.game_over()) {
                    setTimeout(makeBestMove, 300);
                }
            }
        } else {
            // Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø·Ø¹Ø©
            let piece = game.get(square);
            if (piece && piece.color === game.turn()) {
                selectedSquare = square;
                highlightPossibleMoves(square);
            }
        }
    }

    function updateStatus() {
        $('.square-55d63').removeClass('check-highlight');
        if (game.in_check()) {
            // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ù„Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØ´
            game.board().forEach((row, r) => {
                row.forEach((sq, c) => {
                    if (sq && sq.type === 'k' && sq.color === game.turn()) {
                        $('.square-' + String.fromCharCode(97+c) + (8-r)).addClass('check-highlight');
                    }
                });
            });
        }

        if (game.in_checkmate()) {
            // Ø¹Ù†Ø¯ Ø§Ù„ÙƒØ´ Ù…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø°ÙŠ Ø¯ÙˆØ±Ù‡ Ø§Ù„Ø¢Ù† Ù‡Ùˆ Ø§Ù„Ø®Ø§Ø³Ø±
            showResult(game.turn() === 'b' ? "Ø£Ù†Øª ÙØ§Ø¦Ø²" : "Ø£Ù†Øª Ø®Ø§Ø³Ø±", gameMode === 'ai' ? difficultyDepth*15 : 10);
        } else if (game.in_draw()) {
            showResult("ØªØ¹Ø§Ø¯Ù„!", 0);
        }

        document.getElementById('status').innerText = game.turn() === 'b' ? "Ø§Ù„Ø®ØµÙ… ÙŠÙÙƒØ±..." : "Ø¯ÙˆØ±Ùƒ";
        document.getElementById('undo-btn').disabled = (points < 20);
    }

    function updatePoints(amount) {
        points += amount;
        localStorage.setItem('chess_pts_final', points);
        document.getElementById('points-val').innerText = points;
    }

    function handleUndo() {
        if (points >= 20 && !gameOver) {
            game.undo(); if (gameMode === 'ai') game.undo();
            board.position(game.fen());
            updatePoints(-20);
            updateStatus();
        }
    }

    function confirmExit() { if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø©ØŸ")) location.reload(); }
    function showDifficulty() { $('#main-menu').hide(); $('#difficulty-menu').show(); }
    function resetMenu() { $('#difficulty-menu').hide(); $('#main-menu').show(); }

    function startOnlineSearch() {
        $('#main-menu').hide();
        setTimeout(() => { alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹."); location.reload(); }, 2000);
    }

    function startOnlineFromResult() {
        document.getElementById('result-screen').style.display = 'none';
        gameOver = true;
        startOnlineSearch();
    }

    function showResult(resultText, pointsToAdd) {
        gameOver = true;
        removeHighlights();
        selectedSquare = null;

        const resTitle = document.getElementById('res-title');
        const resPoints = document.getElementById('res-points');

        resTitle.innerText = resultText;
        if (resultText.indexOf("ÙØ§Ø¦Ø²") !== -1) {
            resTitle.className = "result-text win-color";
        } else if (resultText.indexOf("Ø®Ø§Ø³Ø±") !== -1) {
            resTitle.className = "result-text lose-color";
        } else {
            resTitle.className = "result-text";
        }

        if (pointsToAdd > 0 && resultText.indexOf("ÙØ§Ø¦Ø²") !== -1) {
            updatePoints(pointsToAdd);
            resPoints.innerText = "+" + pointsToAdd + " Ù†Ù‚Ø§Ø·!";
        } else {
            resPoints.innerText = "";
        }

        document.getElementById('result-screen').style.display = "flex";
        document.getElementById('result-screen').setAttribute('aria-hidden', 'false');
        document.getElementById('exit-btn').style.display = 'none';
        $(document).off('click', '.square-55d63', onSquareClick);
    }

    function goToMainMenu() {
        location.reload();
    }

    function restartGame() {
        document.getElementById('result-screen').style.display = "none";
        document.getElementById('result-screen').setAttribute('aria-hidden', 'true');
        gameOver = false;
        game = new Chess();
        if (board) {
            board.position('start');
        }
        $(document).off('click', '.square-55d63', onSquareClick);
        $(document).on('click', '.square-55d63', onSquareClick);
        document.getElementById('exit-btn').style.display = (document.getElementById('overlay').style.display === 'none') ? 'block' : 'none';
        updateStatus();
    }

    function startGame(mode, depth) {
        gameMode = mode;
        difficultyDepth = depth;
        $('#overlay').fadeOut();
        $('#exit-btn').show();

        if (!board) {
            board = Chessboard('board', {
                position: 'start',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });
        } else {
            board.position('start');
        }

        game = new Chess();
        gameOver = false;
        selectedSquare = null;
        removeHighlights();

        $(document).off('click', '.square-55d63', onSquareClick);
        $(document).on('click', '.square-55d63', onSquareClick);
        updateStatus();
    }

    $(document).ready(function() {
        document.getElementById('points-val').innerText = points;
    });
</script>
</body>
</html>
